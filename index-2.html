<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Anatom√≠a de Mam√≠feros</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --naranja-vibrante: #db6015;
            --amarillo-dorado: #f7be00;
            --azul-oscuro: #244b5a;
            --rojo-ladrillo: #993921;
            --azul-claro: #f0f8ff;
            --blanco: #ffffff;
            --gris-suave: #f5f5f5;
            --verde-exito: #4caf50;
            --rojo-error: #f44336;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--azul-claro) 0%, #e8f4ff 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .contenedor-principal {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--blanco);
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        .barra-encabezado {
            background: linear-gradient(90deg, var(--azul-oscuro) 0%, var(--naranja-vibrante) 100%);
            color: var(--blanco);
            padding: 30px;
            text-align: center;
        }

        .barra-encabezado h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .barra-encabezado p {
            font-size: 16px;
            opacity: 0.95;
        }

        .contenido-quiz {
            padding: 40px;
        }

        /* SECCI√ìN INICIAL */
        .seccion-inicio {
            text-align: center;
            display: none;
        }

        .seccion-inicio.activa {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .emoji-grande {
            font-size: 80px;
            margin: 30px 0;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }

        .seccion-inicio p {
            color: var(--azul-oscuro);
            font-size: 18px;
            line-height: 1.8;
            margin-bottom: 20px;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        .instrucciones {
            background: var(--azul-claro);
            padding: 25px;
            border-radius: 8px;
            margin: 30px 0;
            border-left: 4px solid var(--naranja-vibrante);
            text-align: left;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        .instrucciones h3 {
            color: var(--naranja-vibrante);
            margin-bottom: 15px;
            font-size: 18px;
        }

        .instrucciones ul {
            list-style: none;
            color: var(--azul-oscuro);
            font-size: 16px;
            line-height: 1.8;
        }

        .instrucciones li {
            margin-bottom: 10px;
            padding-left: 30px;
            position: relative;
        }

        .instrucciones li:before {
            content: "‚úì";
            position: absolute;
            left: 0;
            color: var(--verde-exito);
            font-weight: bold;
            font-size: 18px;
        }

        .boton-principal {
            background: linear-gradient(90deg, var(--naranja-vibrante), var(--amarillo-dorado));
            color: var(--blanco);
            border: none;
            padding: 15px 50px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 30px;
        }

        .boton-principal:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(219, 96, 21, 0.3);
        }

        /* SECCION ACTIVIDADES */
        .seccion-actividad {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .seccion-actividad.activa {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .encabezado-actividad {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--amarillo-dorado);
        }

        .encabezado-actividad h2 {
            color: var(--naranja-vibrante);
            font-size: 24px;
            flex: 1;
        }

        .indicador-progreso-actividad {
            background: var(--amarillo-dorado);
            color: var(--azul-oscuro);
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 14px;
        }

        .puntuacion-actual {
            background: var(--verde-exito);
            color: var(--blanco);
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 14px;
            margin-left: 10px;
        }

        /* ACTIVIDAD 1: RELACIONAR CON ITEMS DESORDENADOS */
        .contenedor-pares {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }

        .columna-pares h3 {
            color: var(--naranja-vibrante);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .lista-pares {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .item-par {
            background: linear-gradient(135deg, var(--azul-claro), #e8f4ff);
            border: 2px solid var(--amarillo-dorado);
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: var(--azul-oscuro);
            text-align: center;
            font-size: 14px;
        }

        .item-par:hover {
            background: var(--amarillo-dorado);
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(219, 96, 21, 0.2);
        }

        .item-par.seleccionado {
            background: var(--naranja-vibrante);
            color: var(--blanco);
            border-color: var(--naranja-vibrante);
        }

        .item-par.correcto {
            background: rgba(76, 175, 80, 0.2);
            border-color: var(--verde-exito);
            color: #2e7d32;
            cursor: default;
        }

        /* ACTIVIDAD 2: DRAG AND DROP ORDENAR */
        .contenedor-drag-orden {
            margin: 30px 0;
        }

        .items-desordenados {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .item-draggable {
            background: linear-gradient(90deg, var(--naranja-vibrante), #e88b3d);
            color: var(--blanco);
            padding: 15px;
            border-radius: 8px;
            cursor: grab;
            transition: all 0.3s ease;
            font-weight: 500;
            text-align: center;
            user-select: none;
            font-size: 14px;
            border: 2px solid transparent;
            draggable: true;
        }

        .item-draggable:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(219, 96, 21, 0.3);
        }

        .item-draggable.dragging {
            opacity: 0.5;
        }

        .zona-orden {
            background: var(--azul-claro);
            border: 3px dashed var(--amarillo-dorado);
            border-radius: 8px;
            padding: 20px;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .zona-orden h3 {
            color: var(--naranja-vibrante);
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .items-ordenados {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
        }

        .item-en-orden {
            background: var(--blanco);
            border: 2px solid var(--amarillo-dorado);
            padding: 15px;
            border-radius: 8px;
            color: var(--azul-oscuro);
            font-weight: 500;
            text-align: center;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .numero-orden {
            background: var(--naranja-vibrante);
            color: var(--blanco);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }

        .item-en-orden.correcto {
            background: rgba(76, 175, 80, 0.2);
            border-color: var(--verde-exito);
            color: #2e7d32;
        }

        .item-en-orden.correcto .numero-orden {
            background: var(--verde-exito);
        }

        .item-en-orden.incorrecto {
            background: rgba(244, 67, 54, 0.2);
            border-color: var(--rojo-error);
            color: #c62828;
            animation: shake 0.5s ease;
        }

        .item-en-orden.incorrecto .numero-orden {
            background: var(--rojo-error);
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* ACTIVIDAD 3: CLASIFICAR CON DRAG AND DROP */
        .zona-drop-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }

        .zona-drop {
            background: var(--azul-claro);
            border: 3px dashed var(--amarillo-dorado);
            border-radius: 8px;
            padding: 20px;
            min-height: 300px;
        }

        .zona-drop h3 {
            color: var(--naranja-vibrante);
            font-weight: 600;
            text-align: center;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .items-clasificar-pool {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 25px;
        }

        .item-clasificar {
            background: linear-gradient(90deg, var(--naranja-vibrante), #e88b3d);
            color: var(--blanco);
            padding: 12px;
            border-radius: 8px;
            cursor: grab;
            transition: all 0.3s ease;
            font-weight: 500;
            text-align: center;
            user-select: none;
            font-size: 13px;
            draggable: true;
            border: 2px solid transparent;
        }

        .item-clasificar:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(219, 96, 21, 0.3);
        }

        .item-clasificar.dragging {
            opacity: 0.5;
        }

        .items-clasificados {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: 200px;
        }

        .item-clasificado {
            background: var(--blanco);
            border: 2px solid var(--amarillo-dorado);
            padding: 12px;
            border-radius: 8px;
            color: var(--azul-oscuro);
            font-weight: 500;
            text-align: center;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        .item-clasificado.correcto {
            background: rgba(76, 175, 80, 0.2);
            border-color: var(--verde-exito);
            color: #2e7d32;
        }

        /* ACTIVIDAD 4: SELECCI√ìN M√öLTIPLE */
        .contenedor-seleccion {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 30px 0;
        }

        .pregunta-completa {
            margin-bottom: 40px;
        }

        .pregunta-texto {
            color: var(--azul-oscuro);
            margin-bottom: 20px;
            font-size: 16px;
            font-weight: 600;
        }

        .opcion-seleccion {
            background: linear-gradient(135deg, var(--azul-claro), #e8f4ff);
            border: 3px solid transparent;
            padding: 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 500;
            color: var(--azul-oscuro);
        }

        .opcion-seleccion:hover {
            transform: translateY(-5px);
            border-color: var(--amarillo-dorado);
            box-shadow: 0 6px 15px rgba(219, 96, 21, 0.2);
        }

        .opcion-seleccion.seleccionada {
            border-color: var(--amarillo-dorado);
            background: var(--amarillo-dorado);
            color: var(--azul-oscuro);
        }

        .emoji-opcion {
            font-size: 32px;
            margin-bottom: 10px;
        }

        /* RETROALIMENTACI√ìN */
        .retroalimentacion {
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: 500;
            display: none;
        }

        .retroalimentacion.mostrar {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .retroalimentacion.correcto {
            background: rgba(76, 175, 80, 0.2);
            border-left: 4px solid var(--verde-exito);
            color: #2e7d32;
        }

        .retroalimentacion.incorrecto {
            background: rgba(244, 67, 54, 0.2);
            border-left: 4px solid var(--rojo-error);
            color: #c62828;
        }

        /* BOTONES */
        .contenedor-botones {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .boton-verificar {
            background: var(--naranja-vibrante);
            color: var(--blanco);
            border: none;
            padding: 12px 40px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .boton-verificar:hover:not(:disabled) {
            background: var(--amarillo-dorado);
            color: var(--azul-oscuro);
            transform: scale(1.05);
        }

        /* RESULTADO FINAL */
        .seccion-resultado {
            display: none;
            text-align: center;
        }

        .seccion-resultado.activa {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .tarjeta-resultado {
            background: linear-gradient(135deg, var(--azul-oscuro) 0%, var(--naranja-vibrante) 100%);
            color: var(--blanco);
            padding: 50px 30px;
            border-radius: 12px;
            margin: 30px 0;
            position: relative;
        }

        .sello-resultado {
            font-size: 80px;
            margin-bottom: 20px;
            animation: bounce 1s ease infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .puntuacion-final {
            font-size: 48px;
            font-weight: 700;
            margin: 20px 0;
        }

        .mensaje-resultado {
            font-size: 20px;
            margin-bottom: 30px;
            font-weight: 500;
        }

        .detalles-resultado {
            background: var(--azul-claro);
            color: var(--azul-oscuro);
            padding: 25px;
            border-radius: 8px;
            margin: 30px 0;
            text-align: left;
        }

        .detalle-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #ddd;
            font-size: 16px;
        }

        .detalle-item:last-child {
            border-bottom: none;
        }

        .detalle-nombre {
            font-weight: 600;
            color: var(--naranja-vibrante);
        }

        .detalle-puntos {
            background: var(--amarillo-dorado);
            color: var(--azul-oscuro);
            padding: 5px 12px;
            border-radius: 6px;
            font-weight: 600;
        }

        .contenedor-botones-resultado {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .boton-descargar {
            background: var(--verde-exito);
            color: var(--blanco);
            border: none;
            padding: 14px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .boton-descargar:hover {
            background: #388e3c;
            transform: scale(1.05);
        }

        .boton-mejorar {
            background: var(--naranja-vibrante);
            color: var(--blanco);
            border: none;
            padding: 14px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .boton-mejorar:hover {
            background: #c2530b;
            transform: scale(1.05);
        }

        /* INFORMACI√ìN ESTUDIANTE */
        .seccion-datos-estudiante {
            display: none;
            margin-bottom: 30px;
        }

        .seccion-datos-estudiante.activa {
            display: block;
        }

        .formulario-datos {
            background: var(--azul-claro);
            padding: 25px;
            border-radius: 8px;
            max-width: 500px;
            margin: 0 auto;
        }

        .grupo-entrada {
            margin-bottom: 15px;
            text-align: left;
        }

        .grupo-entrada label {
            display: block;
            color: var(--azul-oscuro);
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .grupo-entrada input {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--amarillo-dorado);
            border-radius: 6px;
            font-size: 14px;
            color: var(--azul-oscuro);
        }

        .grupo-entrada input:focus {
            outline: none;
            border-color: var(--naranja-vibrante);
            background: var(--blanco);
        }

        @media (max-width: 768px) {
            .contenedor-pares,
            .zona-drop-container,
            .contenedor-seleccion,
            .items-desordenados {
                grid-template-columns: 1fr;
            }

            .encabezado-actividad {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .barra-encabezado h1 {
                font-size: 24px;
            }

            .contenido-quiz {
                padding: 20px;
            }
        }

        #resultado-pdf, #resultado-imagen {
            display: none;
        }
    </style>
</head>
<body>
    <div class="contenedor-principal">
        <div class="barra-encabezado">
            <h1>üìö Quiz: Anatom√≠a de Mam√≠feros</h1>
            <p>Evaluaci√≥n Interactiva - 4 Puntos Totales</p>
        </div>

        <div class="contenido-quiz">
            <!-- SECCI√ìN INICIAL -->
            <div class="seccion-inicio activa">
                <div class="emoji-grande">ü¶Å</div>
                <h2 style="color: var(--naranja-vibrante); font-size: 28px; margin-bottom: 20px;">¬°Bienvenido al Quiz!</h2>
                <p>Demuestra lo que aprendiste sobre la anatom√≠a de los mam√≠feros. Tendr√°s la oportunidad de intentar nuevamente si te equivocas.</p>

                <div class="instrucciones">
                    <h3>üìã Instrucciones Importantes:</h3>
                    <ul>
                        <li><strong>4 actividades desafiantes</strong> - 1 punto cada una</li>
                        <li><strong>M√∫ltiples intentos</strong> - Puedes reintentar sin penalizaci√≥n</li>
                        <li><strong>Retroalimentaci√≥n inmediata</strong> - Sabr√°s si acertaste o no</li>
                        <li><strong>Descarga tus resultados</strong> - PDF e imagen para compartir</li>
                        <li><strong>Mejora tu punteo</strong> - Vuelve a intentar para lograr 4/4</li>
                    </ul>
                </div>

                <button class="boton-principal" onclick="irAlQuiz()">Comenzar Quiz üöÄ</button>
            </div>

            <!-- DATOS ESTUDIANTE -->
            <div class="seccion-datos-estudiante">
                <h2 style="color: var(--naranja-vibrante); margin-bottom: 20px;">Informaci√≥n del Estudiante</h2>
                <div class="formulario-datos">
                    <div class="grupo-entrada">
                        <label for="nombre-estudiante">Nombre Completo:</label>
                        <input type="text" id="nombre-estudiante" placeholder="Ej: Juan Garc√≠a L√≥pez">
                    </div>
                    <div class="grupo-entrada">
                        <label for="grado-estudiante">Grado:</label>
                        <input type="text" id="grado-estudiante" placeholder="Ej: 4to A" value="4to Primaria">
                    </div>
                    <div class="grupo-entrada">
                        <label for="fecha-quiz">Fecha:</label>
                        <input type="date" id="fecha-quiz">
                    </div>
                    <button class="boton-principal" onclick="iniciarActividades()" style="width: 100%; margin-top: 20px;">Iniciar Actividades ‚Üí</button>
                </div>
            </div>

            <!-- ACTIVIDAD 1: RELACIONAR CON ITEMS DESORDENADOS -->
            <div class="seccion-actividad" id="actividad-1">
                <div class="encabezado-actividad">
                    <h2>üîó Actividad 1: Relaciona Sistemas con Funciones</h2>
                    <span class="indicador-progreso-actividad">Actividad 1 de 4</span>
                    <span class="puntuacion-actual" id="puntuacion-1">0/1 puntos</span>
                </div>

                <p style="color: var(--azul-oscuro); margin-bottom: 20px; font-size: 16px;">
                    <strong>‚ö†Ô∏è DESAF√çO:</strong> Los items est√°n desordenados. Haz clic en un sistema Y luego en su funci√≥n. Ambos deben estar correos para cambiar de color.
                </p>

                <div class="contenedor-pares">
                    <div class="columna-pares">
                        <h3>üîµ Sistemas del Cuerpo (Desordenados)</h3>
                        <div class="lista-pares" id="sistemas-desordenados">
                            <!-- Se llenar√°n din√°micamente -->
                        </div>
                    </div>

                    <div class="columna-pares">
                        <h3>üü† Funciones (Desordenadas)</h3>
                        <div class="lista-pares" id="funciones-desordenadas">
                            <!-- Se llenar√°n din√°micamente -->
                        </div>
                    </div>
                </div>

                <div class="retroalimentacion" id="retroalimentacion-act1"></div>
                <div class="contenedor-botones">
                    <button class="boton-verificar" onclick="verificarActividad1()">‚úì Verificar Respuesta</button>
                </div>
            </div>

            <!-- ACTIVIDAD 2: DRAG AND DROP ORDENAR -->
            <div class="seccion-actividad" id="actividad-2">
                <div class="encabezado-actividad">
                    <h2>üî¢ Actividad 2: Ordena el Proceso de Digesti√≥n</h2>
                    <span class="indicador-progreso-actividad">Actividad 2 de 4</span>
                    <span class="puntuacion-actual" id="puntuacion-2">0/1 puntos</span>
                </div>

                <p style="color: var(--azul-oscuro); margin-bottom: 20px; font-size: 16px;">
                    <strong>‚ö†Ô∏è DESAF√çO:</strong> Los pasos est√°n desordenados. Arrastra cada item a la zona de orden correcta. Si falla, se pondr√° rojo.
                </p>

                <div class="contenedor-drag-orden">
                    <p style="color: var(--azul-oscuro); font-weight: 600; margin-bottom: 15px;">Pasos del proceso digestivo (desordenados):</p>
                    <div class="items-desordenados" id="items-desordenados">
                        <!-- Se llenar√°n din√°micamente -->
                    </div>

                    <div class="zona-orden" id="zona-orden-digestivo">
                        <h3>Arrastra los pasos en el orden correcto:</h3>
                        <div class="items-ordenados" id="items-orden">
                            <!-- Se llenar√°n aqu√≠ -->
                        </div>
                    </div>
                </div>

                <div class="retroalimentacion" id="retroalimentacion-act2"></div>
                <div class="contenedor-botones">
                    <button class="boton-verificar" onclick="verificarActividad2()">‚úì Verificar Orden</button>
                    <button class="boton-verificar" id="btn-reintentar-act2" style="display: none; background: linear-gradient(90deg, #ff9800, #ffb74d); margin-left: 10px;" onclick="reiniciarActividad2()">üîÑ Reintentar</button>
                </div>
            </div>

            <!-- ACTIVIDAD 3: CLASIFICAR CON DRAG AND DROP -->
            <div class="seccion-actividad" id="actividad-3">
                <div class="encabezado-actividad">
                    <h2>üìä Actividad 3: Clasifica las Estructuras</h2>
                    <span class="indicador-progreso-actividad">Actividad 3 de 4</span>
                    <span class="puntuacion-actual" id="puntuacion-3">0/1 puntos</span>
                </div>

                <p style="color: var(--azul-oscuro); margin-bottom: 20px; font-size: 16px;">
                    <strong>‚ö†Ô∏è DESAF√çO:</strong> Arrastra cada estructura a su zona correcta. Si es incorrecta, ¬°regresar√° autom√°ticamente a su lugar!
                </p>

                <p style="color: var(--azul-oscuro); font-weight: 600; margin-bottom: 15px;">Elementos para clasificar:</p>
                <div class="items-clasificar-pool" id="items-pool">
                    <!-- Se llenar√°n din√°micamente -->
                </div>

                <div class="zona-drop-container">
                    <div class="zona-drop" id="zona-esqueletico">
                        <h3>ü¶¥ Sistema Esquel√©tico</h3>
                        <div class="items-clasificados" id="items-esqueletico"></div>
                    </div>
                    <div class="zona-drop" id="zona-muscular">
                        <h3>üí™ Sistema Muscular</h3>
                        <div class="items-clasificados" id="items-muscular"></div>
                    </div>
                </div>

                <div class="retroalimentacion" id="retroalimentacion-act3"></div>
                <div class="contenedor-botones">
                    <button class="boton-verificar" onclick="verificarActividad3()">‚úì Verificar Clasificaci√≥n</button>
                    <button class="boton-verificar" id="btn-reintentar-act3" style="display: none; background: linear-gradient(90deg, #ff9800, #ffb74d); margin-left: 10px;" onclick="reiniciarActividad3()">üîÑ Reintentar</button>
                </div>
            </div>

            <!-- ACTIVIDAD 4: PREGUNTAS M√öLTIPLE -->
            <div class="seccion-actividad" id="actividad-4">
                <div class="encabezado-actividad">
                    <h2>‚ùì Actividad 4: Preguntas de Conocimiento</h2>
                    <span class="indicador-progreso-actividad">Actividad 4 de 4</span>
                    <span class="puntuacion-actual" id="puntuacion-4">0/1 puntos</span>
                </div>

                <div class="pregunta-completa">
                    <div class="pregunta-texto">‚ùì Pregunta 1: ¬øCu√°l es la funci√≥n principal de los PULMONES?</div>
                    <div class="contenedor-seleccion" id="pregunta-1">
                        <div class="opcion-seleccion" data-correcta="true" onclick="seleccionarOpcionMultiple(this, 'pregunta-1')">
                            <div class="emoji-opcion">ü´Å</div>
                            <div>Intercambiar ox√≠geno con el aire</div>
                        </div>
                        <div class="opcion-seleccion" data-correcta="false" onclick="seleccionarOpcionMultiple(this, 'pregunta-1')">
                            <div class="emoji-opcion">‚ù§Ô∏è</div>
                            <div>Bombear sangre al cuerpo</div>
                        </div>
                        <div class="opcion-seleccion" data-correcta="false" onclick="seleccionarOpcionMultiple(this, 'pregunta-1')">
                            <div class="emoji-opcion">üß†</div>
                            <div>Controlar movimientos</div>
                        </div>
                        <div class="opcion-seleccion" data-correcta="false" onclick="seleccionarOpcionMultiple(this, 'pregunta-1')">
                            <div class="emoji-opcion">üçΩÔ∏è</div>
                            <div>Procesar alimentos</div>
                        </div>
                    </div>
                </div>

                <div class="pregunta-completa">
                    <div class="pregunta-texto">‚ùì Pregunta 2: ¬øQu√© caracter√≠stica diferencia a los MAM√çFEROS de otros animales?</div>
                    <div class="contenedor-seleccion" id="pregunta-2">
                        <div class="opcion-seleccion" data-correcta="true" onclick="seleccionarOpcionMultiple(this, 'pregunta-2')">
                            <div class="emoji-opcion">ü¶Å</div>
                            <div>Sangre caliente y esqueleto interno</div>
                        </div>
                        <div class="opcion-seleccion" data-correcta="false" onclick="seleccionarOpcionMultiple(this, 'pregunta-2')">
                            <div class="emoji-opcion">ü¶é</div>
                            <div>Todos tienen escamas</div>
                        </div>
                        <div class="opcion-seleccion" data-correcta="false" onclick="seleccionarOpcionMultiple(this, 'pregunta-2')">
                            <div class="emoji-opcion">ü¶Ö</div>
                            <div>Todos tienen plumas</div>
                        </div>
                        <div class="opcion-seleccion" data-correcta="false" onclick="seleccionarOpcionMultiple(this, 'pregunta-2')">
                            <div class="emoji-opcion">üê†</div>
                            <div>Solo viven en el agua</div>
                        </div>
                    </div>
                </div>

                <div class="retroalimentacion" id="retroalimentacion-act4"></div>
                <div class="contenedor-botones">
                    <button class="boton-verificar" onclick="verificarActividad4()">‚úì Verificar Respuestas</button>
                </div>
            </div>

            <!-- SECCI√ìN RESULTADO -->
            <div class="seccion-resultado" id="seccion-resultado">
                <div class="tarjeta-resultado" id="tarjeta-resultado-print">
                    <div class="sello-resultado" id="sello-resultado">üéâ</div>
                    <h2>¬°Completaste el Quiz!</h2>
                    <div class="puntuacion-final" id="puntuacion-final">0/4</div>
                    <div class="mensaje-resultado" id="mensaje-resultado">Excelente trabajo</div>
                </div>

                <div class="detalles-resultado">
                    <h3 style="color: var(--naranja-vibrante); margin-bottom: 15px;">üìä Desglose de Puntuaci√≥n:</h3>
                    <div class="detalle-item">
                        <span class="detalle-nombre">üîó Actividad 1: Relacionar Sistemas</span>
                        <span class="detalle-puntos" id="detalle-act1">0/1</span>
                    </div>
                    <div class="detalle-item">
                        <span class="detalle-nombre">üî¢ Actividad 2: Ordenar Digesti√≥n</span>
                        <span class="detalle-puntos" id="detalle-act2">0/1</span>
                    </div>
                    <div class="detalle-item">
                        <span class="detalle-nombre">üìä Actividad 3: Clasificar Estructuras</span>
                        <span class="detalle-puntos" id="detalle-act3">0/1</span>
                    </div>
                    <div class="detalle-item">
                        <span class="detalle-nombre">‚ùì Actividad 4: Preguntas</span>
                        <span class="detalle-puntos" id="detalle-act4">0/1</span>
                    </div>
                    <div class="detalle-item" style="border-top: 2px solid var(--amarillo-dorado); padding-top: 15px; margin-top: 15px;">
                        <span class="detalle-nombre" style="font-size: 18px;">Puntuaci√≥n Total</span>
                        <span class="detalle-puntos" style="font-size: 18px;" id="detalle-total">0/4</span>
                    </div>
                </div>

                <div class="contenedor-botones-resultado">
                    <button class="boton-descargar" onclick="descargarPDF()">üì• Descargar PDF</button>
                    <button class="boton-descargar" onclick="descargarImagenPNG()">üñºÔ∏è Descargar Imagen (PNG)</button>
                    <button class="boton-mejorar" onclick="mejorarPuntaje()">üîÑ Intentar Mejorar</button>
                </div>
            </div>
        </div>

        <!-- SECCIONES PARA DESCARGAR -->
        <div id="resultado-pdf">
            <div style="text-align: center; padding: 40px; font-family: Arial, sans-serif;">
                <h1 style="color: #244b5a; margin-bottom: 10px;">üìö REPORTE DE EVALUACI√ìN</h1>
                <p style="color: #666; margin-bottom: 30px;">Quiz: Anatom√≠a de Mam√≠feros</p>

                <div style="background: #f0f8ff; padding: 30px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #db6015;">
                    <h3 style="color: #244b5a; margin-top: 0;">üë§ Informaci√≥n del Estudiante</h3>
                    <p style="text-align: left; margin: 10px 0;"><strong>Nombre:</strong> <span id="pdf-nombre">No especificado</span></p>
                    <p style="text-align: left; margin: 10px 0;"><strong>Grado:</strong> <span id="pdf-grado">4to Primaria</span></p>
                    <p style="text-align: left; margin: 10px 0;"><strong>Fecha:</strong> <span id="pdf-fecha">No especificada</span></p>
                </div>

                <h2 style="color: #db6015; margin-bottom: 20px;">‚ú® RESULTADO FINAL</h2>
                <div style="font-size: 48px; font-weight: bold; color: #4caf50; margin-bottom: 10px;">
                    <span id="pdf-puntuacion">0</span>/4 PUNTOS
                </div>
                <p style="font-size: 18px; color: #244b5a; margin-bottom: 30px;" id="pdf-mensaje">Excelente trabajo</p>

                <h3 style="color: #244b5a; text-align: left; margin-bottom: 15px;">üìä Desglose por Actividad:</h3>
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                    <tr style="background: #f7be00; color: #244b5a;">
                        <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Actividad</th>
                        <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">Puntuaci√≥n</th>
                    </tr>
                    <tr>
                        <td style="padding: 12px; border: 1px solid #ddd;">Actividad 1: Relacionar Sistemas</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;"><span id="pdf-act1">0</span>/1</td>
                    </tr>
                    <tr style="background: #f5f5f5;">
                        <td style="padding: 12px; border: 1px solid #ddd;">Actividad 2: Ordenar Digesti√≥n</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;"><span id="pdf-act2">0</span>/1</td>
                    </tr>
                    <tr>
                        <td style="padding: 12px; border: 1px solid #ddd;">Actividad 3: Clasificar Estructuras</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;"><span id="pdf-act3">0</span>/1</td>
                    </tr>
                    <tr style="background: #f5f5f5;">
                        <td style="padding: 12px; border: 1px solid #ddd;">Actividad 4: Preguntas</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;"><span id="pdf-act4">0</span>/1</td>
                    </tr>
                    <tr style="background: #db6015; color: white; font-weight: bold;">
                        <td style="padding: 12px; border: 1px solid #ddd;">TOTAL</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;"><span id="pdf-total">0</span>/4</td>
                    </tr>
                </table>

                <div style="background: #f0f8ff; padding: 20px; border-radius: 8px; border-left: 4px solid #4caf50; text-align: left;">
                    <p style="margin: 0; color: #244b5a; font-size: 14px;">
                        ‚úì Generado el <span id="pdf-fecha-completa">-</span><br>
                        üìé Materia: Ciencias Naturales | üìö Grado: 4to Primaria | üìñ Lecci√≥n: 3 - Anatom√≠a de Mam√≠feros
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // VARIABLES GLOBALES
        let puntuaciones = { act1: 0, act2: 0, act3: 0, act4: 0 };
        let seleccionesAct4 = { 'pregunta-1': null, 'pregunta-2': null };
        let itemDragActual = null;
        let draggedElement = null;

        // Datos de sistemas y funciones
        const sistemasYFunciones = [
            { sistema: 'esqueletico', nombre: 'ü¶¥ Sistema Esquel√©tico', funcion: 'Sostiene y protege √≥rganos' },
            { sistema: 'muscular', nombre: 'üí™ Sistema Muscular', funcion: 'Permite el movimiento' },
            { sistema: 'circulatorio', nombre: '‚ù§Ô∏è Sistema Circulatorio', funcion: 'Transporta ox√≠geno y nutrientes' },
            { sistema: 'respiratorio', nombre: 'ü´Å Sistema Respiratorio', funcion: 'Permite intercambiar gases' }
        ];

        const procesoDigestivo = [
            { orden: 1, texto: 'Masticas el alimento en la boca' },
            { orden: 2, texto: 'El alimento viaja por el es√≥fago' },
            { orden: 3, texto: 'El est√≥mago digiere el alimento' },
            { orden: 4, texto: 'Los intestinos absorben nutrientes' }
        ];

        const estructuras = [
            { tipo: 'esqueletico', nombre: 'ü¶¥ F√©mur' },
            { tipo: 'muscular', nombre: 'üí™ B√≠ceps' },
            { tipo: 'esqueletico', nombre: 'ü¶¥ V√©rtebra' },
            { tipo: 'muscular', nombre: 'ü¶µ Gemelos' },
            { tipo: 'esqueletico', nombre: 'ü¶¥ Costilla' },
            { tipo: 'muscular', nombre: 'üí™ Tr√≠ceps' }
        ];

        // Establecer fecha
        document.getElementById('fecha-quiz').valueAsDate = new Date();
        document.getElementById('pdf-fecha-completa').textContent = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });

        // ===== INICIALIZACI√ìN =====
        function irAlQuiz() {
            document.querySelector('.seccion-inicio').classList.remove('activa');
            document.querySelector('.seccion-datos-estudiante').classList.add('activa');
        }

        function iniciarActividades() {
            const nombre = document.getElementById('nombre-estudiante').value;
            if (!nombre) {
                alert('Por favor, ingresa tu nombre completo');
                return;
            }
            window.datosEstudiante = {
                nombre: nombre,
                grado: document.getElementById('grado-estudiante').value,
                fecha: document.getElementById('fecha-quiz').value
            };
            document.querySelector('.seccion-datos-estudiante').classList.remove('activa');
            inicializarActividad1();
            document.getElementById('actividad-1').classList.add('activa');
        }

        function irAActividad(numero) {
            document.querySelectorAll('.seccion-actividad').forEach(sec => sec.classList.remove('activa'));
            
            if (numero === 1) inicializarActividad1();
            if (numero === 2) inicializarActividad2();
            if (numero === 3) inicializarActividad3();
            
            document.getElementById(`actividad-${numero}`).classList.add('activa');
            window.scrollTo(0, 0);
        }

        // ===== ACTIVIDAD 1: INICIALIZACI√ìN =====
        function inicializarActividad1() {
            // Desordenar sistemas
            let sistemas = [...sistemasYFunciones].sort(() => Math.random() - 0.5);
            let funciones = [...sistemasYFunciones].sort(() => Math.random() - 0.5);

            const sistemasDiv = document.getElementById('sistemas-desordenados');
            const funcionesDiv = document.getElementById('funciones-desordenadas');
            sistemasDiv.innerHTML = '';
            funcionesDiv.innerHTML = '';

            sistemas.forEach(s => {
                const div = document.createElement('div');
                div.className = 'item-par';
                div.setAttribute('data-sistema', s.sistema);
                div.textContent = s.nombre;
                div.onclick = () => seleccionarParAct1(div);
                sistemasDiv.appendChild(div);
            });

            funciones.forEach(f => {
                const div = document.createElement('div');
                div.className = 'item-par';
                div.setAttribute('data-sistema', f.sistema);
                div.textContent = f.funcion;
                div.onclick = () => seleccionarParAct1(div);
                funcionesDiv.appendChild(div);
            });
        }

        let parejaEnProceso = null;

        function seleccionarParAct1(elemento) {
            if (elemento.classList.contains('correcto')) return;

            if (parejaEnProceso === null) {
                parejaEnProceso = elemento;
                elemento.classList.add('seleccionado');
            } else if (parejaEnProceso === elemento) {
                elemento.classList.remove('seleccionado');
                parejaEnProceso = null;
            } else if (parejaEnProceso.getAttribute('data-sistema') === elemento.getAttribute('data-sistema')) {
                parejaEnProceso.classList.add('correcto');
                elemento.classList.add('correcto');
                parejaEnProceso.classList.remove('seleccionado');
                parejaEnProceso = null;
            } else {
                parejaEnProceso.classList.remove('seleccionado');
                parejaEnProceso = elemento;
                elemento.classList.add('seleccionado');
            }
        }

        function verificarActividad1() {
            const correctos = document.querySelectorAll('#actividad-1 .item-par.correcto');
            if (correctos.length === 8) {
                completarActividad('act1', 1);
                mostrarRetroalimentacion('retroalimentacion-act1', 'correcto', '‚úÖ ¬°Perfecto! Relacionaste correctamente todos los sistemas.');
                setTimeout(() => irAActividad(2), 1500);
            } else {
                mostrarRetroalimentacion('retroalimentacion-act1', 'incorrecto', `‚ùå A√∫n no est√° completo. Has acertado ${correctos.length}/8 pares.`);
            }
        }

        // ===== ACTIVIDAD 2: DRAG AND DROP CON SORTABLE.JS =====
        let sortableAct2 = null;

        function inicializarActividad2() {
            const pool = document.getElementById('items-desordenados');
            pool.innerHTML = '';
            
            // Desordenar proceso
            let desordenado = [...procesoDigestivo].sort(() => Math.random() - 0.5);
            desordenado.forEach((paso, index) => {
                const div = document.createElement('div');
                div.className = 'item-draggable';
                div.setAttribute('data-orden', paso.orden);
                div.textContent = paso.texto;
                pool.appendChild(div);
            });

            document.getElementById('items-orden').innerHTML = '';
            
            // Inicializar Sortable para la zona de orden
            setTimeout(() => {
                if (sortableAct2) sortableAct2.destroy();
                sortableAct2 = Sortable.create(document.getElementById('items-orden'), {
                    group: 'actividad2',
                    animation: 150,
                    ghostClass: 'dragging',
                    forceFallback: true,
                    onAdd: function(evt) {
                        const item = evt.item;
                        const orden = item.getAttribute('data-orden');
                        const clone = item.cloneNode(true);
                        clone.className = 'item-en-orden';
                        const numero = document.createElement('div');
                        numero.className = 'numero-orden';
                        numero.textContent = document.getElementById('items-orden').children.length;
                        clone.textContent = numero.textContent + '. ' + clone.textContent;
                        clone.insertBefore(numero, clone.firstChild);
                        document.getElementById('items-orden').appendChild(clone);
                        item.remove();
                    }
                });
            }, 100);
            
            // Inicializar Sortable para el pool
            Sortable.create(document.getElementById('items-desordenados'), {
                group: 'actividad2',
                animation: 150,
                ghostClass: 'dragging',
                forceFallback: true
            });
        }

        function dragStart(e) {
            draggedElement = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function dragEnd(e) {
            e.target.classList.remove('dragging');
        }

        function dragover(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function drop(e) {
            e.preventDefault();
        }

        function verificarActividad2() {
            const items = document.querySelectorAll('#items-orden .item-en-orden');
            let correcto = true;
            let indice = 1;

            items.forEach((item, idx) => {
                const orden = item.getAttribute('data-orden');
                if (parseInt(orden) === indice) {
                    item.classList.add('correcto');
                    item.classList.remove('incorrecto');
                } else {
                    item.classList.add('incorrecto');
                    correcto = false;
                    setTimeout(() => {
                        item.style.animation = 'shake 0.5s ease';
                    }, 100);
                }
                indice++;
            });

            if (correcto && items.length === 4) {
                completarActividad('act2', 1);
                mostrarRetroalimentacion('retroalimentacion-act2', 'correcto', '‚úÖ ¬°Excelente! Ordenaste correctamente el proceso digestivo.');
                document.getElementById('btn-reintentar-act2').style.display = 'none';
                setTimeout(() => irAActividad(3), 1500);
            } else if (items.length < 4) {
                mostrarRetroalimentacion('retroalimentacion-act2', 'incorrecto', `‚ùå Debes ordenar TODOS los pasos. Has ordenado ${items.length}/4.`);
                document.getElementById('btn-reintentar-act2').style.display = 'inline-block';
            } else {
                mostrarRetroalimentacion('retroalimentacion-act2', 'incorrecto', '‚ùå El orden no es correcto. Revisa y vuelve a intentarlo.');
                document.getElementById('btn-reintentar-act2').style.display = 'inline-block';
            }
        }

        function reiniciarActividad2() {
            document.getElementById('btn-reintentar-act2').style.display = 'none';
            document.getElementById('retroalimentacion-act2').innerHTML = '';
            inicializarActividad2();
        }

        // ===== ACTIVIDAD 3: CLASIFICAR CON SORTABLE.JS =====
        let sortablesAct3 = [];

        function inicializarActividad3() {
            const pool = document.getElementById('items-pool');
            pool.innerHTML = '';
            document.getElementById('items-esqueletico').innerHTML = '';
            document.getElementById('items-muscular').innerHTML = '';

            estructuras.forEach((est, index) => {
                const div = document.createElement('div');
                div.className = 'item-clasificar';
                div.setAttribute('data-tipo', est.tipo);
                div.setAttribute('data-id', index);
                div.textContent = est.nombre;
                pool.appendChild(div);
            });

            // Destruir sortables anteriores
            sortablesAct3.forEach(s => s.destroy());
            sortablesAct3 = [];

            setTimeout(() => {
                // Pool de items
                sortablesAct3.push(Sortable.create(document.getElementById('items-pool'), {
                    group: 'clasificacion',
                    animation: 150,
                    ghostClass: 'dragging',
                    forceFallback: true
                }));

                // Zona Esquel√©tico
                sortablesAct3.push(Sortable.create(document.getElementById('items-esqueletico'), {
                    group: 'clasificacion',
                    animation: 150,
                    ghostClass: 'dragging',
                    forceFallback: true,
                    onAdd: function(evt) {
                        const item = evt.item;
                        const tipo = item.getAttribute('data-tipo');
                        if (tipo !== 'esqueletico') {
                            setTimeout(() => {
                                document.getElementById('items-pool').appendChild(item);
                                mostrarRetroalimentacion('retroalimentacion-act3', 'incorrecto', '‚ùå Esa estructura no pertenece al Sistema Esquel√©tico.');
                            }, 300);
                        } else {
                            item.className = 'item-clasificado correcto';
                        }
                    }
                }));

                // Zona Muscular
                sortablesAct3.push(Sortable.create(document.getElementById('items-muscular'), {
                    group: 'clasificacion',
                    animation: 150,
                    ghostClass: 'dragging',
                    forceFallback: true,
                    onAdd: function(evt) {
                        const item = evt.item;
                        const tipo = item.getAttribute('data-tipo');
                        if (tipo !== 'muscular') {
                            setTimeout(() => {
                                document.getElementById('items-pool').appendChild(item);
                                mostrarRetroalimentacion('retroalimentacion-act3', 'incorrecto', '‚ùå Esa estructura no pertenece al Sistema Muscular.');
                            }, 300);
                        } else {
                            item.className = 'item-clasificado correcto';
                        }
                    }
                }));
            }, 100);
        }

        function dragStartClasificacion(e) {
            draggedElement = e.target;
            itemDragActual = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function dropClasificacion(e, tipoZona) {
            e.preventDefault();
        }

        function verificarActividad3() {
            const clasificados = document.querySelectorAll('#actividad-3 .item-clasificado');
            if (clasificados.length === 6) {
                completarActividad('act3', 1);
                mostrarRetroalimentacion('retroalimentacion-act3', 'correcto', '‚úÖ ¬°Correcto! Clasificaste todas las estructuras correctamente.');
                document.getElementById('btn-reintentar-act3').style.display = 'none';
                setTimeout(() => irAActividad(4), 1500);
            } else {
                mostrarRetroalimentacion('retroalimentacion-act3', 'incorrecto', `‚ùå A√∫n no est√° completo. Has clasificado ${clasificados.length}/6 correctamente. Intenta de nuevo.`);
                document.getElementById('btn-reintentar-act3').style.display = 'inline-block';
            }
        }

        function reiniciarActividad3() {
            document.getElementById('btn-reintentar-act3').style.display = 'none';
            document.getElementById('retroalimentacion-act3').innerHTML = '';
            inicializarActividad3();
        }

        // ===== ACTIVIDAD 4: PREGUNTAS M√öLTIPLE =====
        function seleccionarOpcionMultiple(elemento, pregunta) {
            const opciones = document.querySelectorAll(`#${pregunta} .opcion-seleccion`);
            opciones.forEach(op => op.classList.remove('seleccionada'));
            elemento.classList.add('seleccionada');
            seleccionesAct4[pregunta] = elemento.getAttribute('data-correcta') === 'true';
        }

        function verificarActividad4() {
            if (seleccionesAct4['pregunta-1'] && seleccionesAct4['pregunta-2']) {
                completarActividad('act4', 1);
                mostrarRetroalimentacion('retroalimentacion-act4', 'correcto', '‚úÖ ¬°Correcto! Respondiste correctamente ambas preguntas.');
                setTimeout(mostrarResultado, 1500);
            } else {
                let msg = '‚ùå ';
                if (!seleccionesAct4['pregunta-1']) msg += 'La pregunta 1 es incorrecta. ';
                if (!seleccionesAct4['pregunta-2']) msg += 'La pregunta 2 es incorrecta.';
                mostrarRetroalimentacion('retroalimentacion-act4', 'incorrecto', msg);
            }
        }

        // ===== UTILIDADES =====
        function mostrarRetroalimentacion(id, tipo, mensaje) {
            const elemento = document.getElementById(id);
            elemento.className = `retroalimentacion mostrar ${tipo}`;
            elemento.textContent = mensaje;
        }

        function completarActividad(numero, puntos) {
            puntuaciones[numero] = puntos;
            const numAct = numero.slice(-1);
            document.getElementById(`puntuacion-${numAct}`).innerHTML = `${puntos}/1 puntos ‚úì`;
        }

        function mostrarResultado() {
            const total = Object.values(puntuaciones).reduce((a, b) => a + b, 0);
            let mensaje = '', sello = '';

            if (total === 4) {
                mensaje = 'üåü ¬°PERFECTO! Eres un experto en anatom√≠a de mam√≠feros.';
                sello = 'üèÜ';
            } else if (total === 3) {
                mensaje = 'üëè ¬°Excelente! Dominaste la mayor√≠a de los temas.';
                sello = '‚≠ê';
            } else if (total === 2) {
                mensaje = 'üëç ¬°Buen esfuerzo! Tienes buenas bases.';
                sello = 'üí™';
            } else {
                mensaje = 'üìö Sigue practicando, ¬°t√∫ puedes!';
                sello = 'üéØ';
            }

            document.getElementById('puntuacion-final').textContent = `${total}/4`;
            document.getElementById('mensaje-resultado').textContent = mensaje;
            document.getElementById('sello-resultado').textContent = sello;
            document.getElementById('detalle-act1').textContent = `${puntuaciones.act1}/1`;
            document.getElementById('detalle-act2').textContent = `${puntuaciones.act2}/1`;
            document.getElementById('detalle-act3').textContent = `${puntuaciones.act3}/1`;
            document.getElementById('detalle-act4').textContent = `${puntuaciones.act4}/1`;
            document.getElementById('detalle-total').textContent = `${total}/4`;

            // PDF
            document.getElementById('pdf-nombre').textContent = window.datosEstudiante?.nombre || '';
            document.getElementById('pdf-grado').textContent = window.datosEstudiante?.grado || '';
            document.getElementById('pdf-fecha').textContent = window.datosEstudiante?.fecha || '';
            document.getElementById('pdf-puntuacion').textContent = total;
            document.getElementById('pdf-mensaje').textContent = mensaje;
            document.getElementById('pdf-act1').textContent = puntuaciones.act1;
            document.getElementById('pdf-act2').textContent = puntuaciones.act2;
            document.getElementById('pdf-act3').textContent = puntuaciones.act3;
            document.getElementById('pdf-act4').textContent = puntuaciones.act4;
            document.getElementById('pdf-total').textContent = total;

            document.querySelectorAll('.seccion-actividad').forEach(sec => sec.classList.remove('activa'));
            document.getElementById('seccion-resultado').classList.add('activa');
        }

        // ===== DESCARGAR RESULTADOS =====
        function descargarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            let yPosition = 15;

            // Color naranja Escolaris
            const colorNaranja = [219, 96, 21];
            const colorAzul = [36, 75, 90];
            const colorAmarillo = [247, 190, 0];

            // Encabezado con l√≠nea de color
            doc.setDrawColor(colorNaranja[0], colorNaranja[1], colorNaranja[2]);
            doc.setLineWidth(1);
            doc.line(15, yPosition, pageWidth - 15, yPosition);
            yPosition += 8;

            // T√≠tulo principal
            doc.setFontSize(20);
            doc.setTextColor(colorAzul[0], colorAzul[1], colorAzul[2]);
            doc.setFont(undefined, 'bold');
            doc.text('REPORTE DE EVALUACION', pageWidth / 2, yPosition, { align: 'center' });
            yPosition += 10;

            // Subt√≠tulo
            doc.setFontSize(12);
            doc.setTextColor(100, 100, 100);
            doc.setFont(undefined, 'normal');
            doc.text('Quiz: Anatomia de Mamiferos', pageWidth / 2, yPosition, { align: 'center' });
            yPosition += 3;
            doc.text('Materia: Ciencias Naturales | Grado: 4to Primaria', pageWidth / 2, yPosition, { align: 'center' });
            yPosition += 12;

            // Secci√≥n de informaci√≥n del estudiante
            doc.setFillColor(colorAmarillo[0], colorAmarillo[1], colorAmarillo[2]);
            doc.rect(15, yPosition - 5, pageWidth - 30, 8, 'F');
            doc.setFontSize(11);
            doc.setTextColor(colorAzul[0], colorAzul[1], colorAzul[2]);
            doc.setFont(undefined, 'bold');
            doc.text('INFORMACION DEL ESTUDIANTE', 20, yPosition);
            yPosition += 12;

            // Datos del estudiante
            doc.setFontSize(10);
            doc.setTextColor(80, 80, 80);
            doc.setFont(undefined, 'normal');
            const nombre = window.datosEstudiante?.nombre || 'No especificado';
            const grado = window.datosEstudiante?.grado || '4to Primaria';
            const fecha = window.datosEstudiante?.fecha || 'No especificada';

            doc.text('Nombre:', 20, yPosition);
            doc.setFont(undefined, 'bold');
            doc.text(nombre, 55, yPosition);
            doc.setFont(undefined, 'normal');
            yPosition += 8;

            doc.text('Grado:', 20, yPosition);
            doc.setFont(undefined, 'bold');
            doc.text(grado, 55, yPosition);
            doc.setFont(undefined, 'normal');
            yPosition += 8;

            doc.text('Fecha:', 20, yPosition);
            doc.setFont(undefined, 'bold');
            doc.text(fecha, 55, yPosition);
            doc.setFont(undefined, 'normal');
            yPosition += 15;

            // Resultado final
            const total = Object.values(puntuaciones).reduce((a, b) => a + b, 0);
            
            doc.setFillColor(colorAzul[0], colorAzul[1], colorAzul[2]);
            doc.rect(15, yPosition - 5, pageWidth - 30, 12, 'F');
            doc.setFontSize(14);
            doc.setTextColor(255, 255, 255);
            doc.setFont(undefined, 'bold');
            doc.text('RESULTADO FINAL', 20, yPosition + 2);
            doc.setFontSize(16);
            doc.setFillColor(76, 175, 80);
            doc.rect(pageWidth - 40, yPosition - 5, 25, 12, 'F');
            doc.setTextColor(255, 255, 255);
            doc.text(`${total}/4`, pageWidth - 27, yPosition + 2, { align: 'center' });
            yPosition += 18;

            // Mensaje personalizado
            let mensaje = '';
            let estado = '';
            if (total === 4) {
                mensaje = 'PERFECTO! Eres un experto en anatomia de mamiferos.';
                estado = 'EXCELENTE';
            } else if (total === 3) {
                mensaje = 'EXCELENTE! Dominaste la mayoria de los temas.';
                estado = 'MUY BUENO';
            } else if (total === 2) {
                mensaje = 'BUEN ESFUERZO! Tienes buenas bases para continuar aprendiendo.';
                estado = 'BUENO';
            } else {
                mensaje = 'SIGUE PRACTICANDO! Tu puedes mejorar tu desempeno.';
                estado = 'REGULAR';
            }

            doc.setFontSize(11);
            doc.setTextColor(colorNaranja[0], colorNaranja[1], colorNaranja[2]);
            doc.setFont(undefined, 'bold');
            doc.text(mensaje, pageWidth / 2, yPosition, { align: 'center', maxWidth: pageWidth - 30 });
            yPosition += 12;

            // Tabla de detalles
            doc.setFillColor(colorAmarillo[0], colorAmarillo[1], colorAmarillo[2]);
            doc.rect(15, yPosition - 5, pageWidth - 30, 8, 'F');
            doc.setFontSize(11);
            doc.setTextColor(colorAzul[0], colorAzul[1], colorAzul[2]);
            doc.setFont(undefined, 'bold');
            doc.text('DESGLOSE POR ACTIVIDAD', 20, yPosition);
            yPosition += 10;

            // Encabezado tabla
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(80, 80, 80);
            doc.text('Actividad', 20, yPosition);
            doc.text('Puntuacion', pageWidth - 35, yPosition);
            yPosition += 7;

            // L√≠nea separadora
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.3);
            doc.line(15, yPosition - 1, pageWidth - 15, yPosition - 1);

            // Datos tabla
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            const actividades = [
                { num: 1, nombre: 'Relacionar Sistemas', puntos: puntuaciones.act1 },
                { num: 2, nombre: 'Ordenar Digestion', puntos: puntuaciones.act2 },
                { num: 3, nombre: 'Clasificar Estructuras', puntos: puntuaciones.act3 },
                { num: 4, nombre: 'Preguntas de Conocimiento', puntos: puntuaciones.act4 }
            ];

            actividades.forEach((act, index) => {
                if (index % 2 === 0) {
                    doc.setFillColor(245, 245, 245);
                    doc.rect(15, yPosition - 3.5, pageWidth - 30, 6, 'F');
                }
                doc.setTextColor(80, 80, 80);
                doc.text(`Actividad ${act.num}: ${act.nombre}`, 20, yPosition);
                
                // Color verde si es correcto
                if (act.puntos === 1) {
                    doc.setTextColor(76, 175, 80);
                    doc.setFont(undefined, 'bold');
                } else {
                    doc.setTextColor(244, 67, 54);
                }
                doc.text(`${act.puntos}/1`, pageWidth - 30, yPosition);
                doc.setFont(undefined, 'normal');
                yPosition += 6;
            });

            // L√≠nea separadora
            yPosition += 1;
            doc.setDrawColor(200, 200, 200);
            doc.line(15, yPosition, pageWidth - 15, yPosition);
            yPosition += 6;

            // Total final
            doc.setFont(undefined, 'bold');
            doc.setFontSize(10);
            doc.setTextColor(colorAzul[0], colorAzul[1], colorAzul[2]);
            doc.text('PUNTUACION TOTAL:', 20, yPosition);
            doc.setFontSize(12);
            doc.setTextColor(76, 175, 80);
            doc.text(`${total}/4`, pageWidth - 30, yPosition);

            // Footer
            yPosition = pageHeight - 15;
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.setFont(undefined, 'normal');
            const fechaGen = new Date().toLocaleDateString('es-ES', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            doc.line(15, yPosition - 8, pageWidth - 15, yPosition - 8);
            doc.text(`Generado: ${fechaGen}`, 20, yPosition - 3);
            doc.text('Colegio Escolaris | Quiz Interactivo de Evaluacion', pageWidth / 2, yPosition - 3, { align: 'center' });
            doc.text('Este reporte es confidencial y esta destinado unicamente al estudiante y su maestra.', pageWidth - 20, yPosition - 3, { align: 'right' });

            // Descargar
            const nombreArchivo = `Quiz_Anatomia_${nombre.replace(/\s+/g, '_')}_${new Date().getTime()}.pdf`;
            doc.save(nombreArchivo);
        }

        function descargarImagenPNG() {
            const elemento = document.getElementById('tarjeta-resultado-print');
            html2canvas(elemento, { scale: 2, backgroundColor: '#ffffff' }).then(canvas => {
                const link = document.createElement('a');
                link.href = canvas.toDataURL('image/png');
                link.download = `Quiz_Anatomia_${window.datosEstudiante?.nombre?.replace(/\s+/g, '_')}.png`;
                link.click();
            });
        }

        function mejorarPuntaje() {
            puntuaciones = { act1: 0, act2: 0, act3: 0, act4: 0 };
            seleccionesAct4 = { 'pregunta-1': null, 'pregunta-2': null };
            document.querySelectorAll('.seccion-actividad').forEach(sec => sec.classList.remove('activa'));
            irAActividad(1);
        }
    </script>
</body>
</html>
